{{ define "main" }}

<!-- ðŸ¡ Home Section (Merged Hero + About) -->
<section id="home" class="hero">
  <div class="container">
    <div class="hero-content">
      <h1>Welcome to Capulong Farms</h1>
      <p>Fresh produce and farm supplies delivered from our farm to your table</p>
    </div>

    <div class="about-content" style="margin-top: 3rem;">
      <div class="about-image">
        <img src="/images/farm-photo.jpg" alt="Capulong Farms">
      </div>

      <div class="about-text">
        <p style="color: white;">Capulong Farms is a family-owned business...</p>
        <p style="color: white;">Located in Lanang Candaba Pampanga Philippines...</p>
        <p style="color: white;">We believe in sustainable farming practices...</p>
        <p style="color: white;">Our commitment is quality, freshness and supporting local agriculture.</p>
      </div>
    </div>
  </div>
</section>

<!-- ðŸ’³ Buy & Pay Section -->
<section id="order" class="contact-section">
  <div class="container">
    <h2>Buy & Pay</h2>
    <div class="contact-grid">
      <div class="contact-info">
        <h3>How to Order</h3>
        <p>Click the Product Photo or the WhatsApp Button to place your order, we'll confirm availability and arrange delivery.</p>
        <div class="contact-details">
          <p><i class="fas fa-map-marker-alt"></i> Philippines</p>
          <p><i class="fab fa-whatsapp"></i> WhatsApp Business</p>
        </div>
      </div>
      <div class="payment-info">
        <h3>Payment via GCash</h3>
        <p>Scan the QR code below to pay via GCash:</p>
        <div class="gcash-qr">
          <img src="{{ .Site.Params.gcash_qr_image }}" alt="GCash QR Code">
        </div>
      </div>
    </div>
  </div>
</section>

<!-- ðŸ§º Products Section with Tabs -->
<section id="products" class="products-section">
  <div class="container">
    <h2>Products & Prices</h2>

    <!-- Tabs Navigation -->
    <div class="tabs">
      {{ range $index, $category := .Site.Data.products.categories }}
        <button class="tab-button {{ if eq $index 0 }}active{{ end }}" data-tab="tab-{{ $index }}">{{ $category.name }}</button>
      {{ end }}
    </div>

    <!-- Tabs Content -->
    {{ range $index, $category := .Site.Data.products.categories }}
    <div id="tab-{{ $index }}" class="tab-content {{ if eq $index 0 }}active{{ end }}">
      <div class="products-grid">
        {{ range $category.products }}
        {{ if not .discontinue }}
        <div class="product-card {{ if not .available }}not-available{{ end }}" data-product-name="{{ .name }}" data-product-price="{{ .price }}">
          <div class="product-image">
            {{ if .available }}
              <a href="javascript:void(0);" onclick="orderProduct('{{ .name }}', '{{ .price }}')" style="display:block; position: relative;">
                <img src="{{ .image | relURL }}" alt="{{ .name }}" loading="lazy" onerror="this.src='/images/placeholder.png'">
                <div class="available-icon">âœ”</div>
              </a>
            {{ else }}
              <img src="{{ .image | relURL }}" alt="{{ .name }}" loading="lazy" onerror="this.src='/images/placeholder.png'">
              <div class="watermark">NOT AVAILABLE</div>
              <div class="not-available-icon">âœ–</div>
            {{ end }}
          </div>
          <h4>{{ .name }}</h4>
          <p class="price">{{ .price }}</p>
          {{ if .available }}
          <div class="quantity-container">
            <label class="quantity-label">Quantity:</label>
            <div class="quantity-controls">
              <button class="qty-btn minus-btn" onclick="changeQuantity('{{ .name | urlize }}', -1)">-</button>
              <input type="number" class="qty-input" id="qty-{{ .name | urlize }}" value="1" min="1" max="9999" onchange="validateQuantity('{{ .name | urlize }}')" oninput="validateQuantityInput('{{ .name | urlize }}')" onkeypress="return isNumberKey(event)">
              <button class="qty-btn plus-btn" onclick="changeQuantity('{{ .name | urlize }}', 1)">+</button>
            </div>
          </div>
          <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
            <button class="add-to-cart-btn" onclick="addToCartWithQuantity('{{ .name }}', '{{ .price }}', '{{ .name | urlize }}')">
              <i class="fas fa-shopping-cart"></i> Add to Cart
            </button>
          </div>
          {{ end }}
        </div>
        {{ end }}
        {{ end }}
      </div>
    </div>
    {{ end }}
  </div>

  <!-- Inline Tab Script -->
  <script>
    // Cart Management
    const CART_KEY = 'capulong_cart';
    
    function getCart() {
      const cart = localStorage.getItem(CART_KEY);
      return cart ? JSON.parse(cart) : [];
    }
    
    function saveCart(cart) {
      localStorage.setItem(CART_KEY, JSON.stringify(cart));
      updateCartCount();
    }
    
    function addToCart(productName, productPrice) {
      const cart = getCart();
      const existingItem = cart.find(item => item.name === productName);
      
      if (existingItem) {
        existingItem.quantity += 1;
      } else {
        cart.push({ name: productName, price: productPrice, quantity: 1 });
      }
      
      saveCart(cart);
      alert(productName + ' added to cart!');
    }
    
    function addToCartWithQuantity(productName, productPrice, productId) {
      const quantityInput = document.getElementById('qty-' + productId);
      const quantity = parseInt(quantityInput.value) || 1;
      
      const cart = getCart();
      const existingItem = cart.find(item => item.name === productName);
      
      if (existingItem) {
        existingItem.quantity += quantity;
      } else {
        cart.push({ name: productName, price: productPrice, quantity: quantity });
      }
      
      saveCart(cart);
      alert(quantity + 'x ' + productName + ' added to cart!');
      
      // Reset quantity to 1 after adding
      quantityInput.value = 1;
    }
    
    function changeQuantity(productId, change) {
      const quantityInput = document.getElementById('qty-' + productId);
      let currentValue = parseInt(quantityInput.value) || 1;
      let newValue = currentValue + change;
      
      // Ensure value stays within bounds
      if (newValue < 1) newValue = 1;
      if (newValue > 9999) newValue = 9999;
      
      quantityInput.value = newValue;
    }
    
    function validateQuantity(productId) {
      const quantityInput = document.getElementById('qty-' + productId);
      let value = quantityInput.value.trim();
      
      // If empty or invalid, set to 1
      if (value === '' || isNaN(value) || value <= 0) {
        quantityInput.value = 1;
        return;
      }
      
      let numValue = parseInt(value);
      
      // Ensure value stays within bounds
      if (numValue < 1) numValue = 1;
      if (numValue > 9999) numValue = 9999;
      
      quantityInput.value = numValue;
    }
    
    function validateQuantityInput(productId) {
      const quantityInput = document.getElementById('qty-' + productId);
      let value = quantityInput.value;
      
      // Remove any non-numeric characters
      value = value.replace(/[^0-9]/g, '');
      
      // If empty after cleaning, don't set to 1 immediately (let user continue typing)
      if (value === '') {
        quantityInput.value = '';
        return;
      }
      
      // Convert to number and validate bounds
      let numValue = parseInt(value);
      if (numValue < 1) numValue = 1;
      if (numValue > 9999) numValue = 9999;
      
      quantityInput.value = numValue;
    }
    
    function isNumberKey(evt) {
      var charCode = (evt.which) ? evt.which : evt.keyCode;
      // Allow: backspace, delete, tab, escape, enter
      if (charCode == 46 || charCode == 8 || charCode == 9 || charCode == 27 || charCode == 13) {
        return true;
      }
      // Allow: Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+X
      if (charCode == 65 && evt.ctrlKey === true || 
          charCode == 67 && evt.ctrlKey === true || 
          charCode == 86 && evt.ctrlKey === true ||
          charCode == 88 && evt.ctrlKey === true) {
        return true;
      }
      // Ensure that it is a number and stop the keypress
      if (charCode < 48 || charCode > 57) {
        return false;
      }
      return true;
    }
    
    function updateCartCount() {
      const cart = getCart();
      const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
      const cartBadge = document.getElementById('cart-count');
      if (cartBadge) {
        cartBadge.textContent = totalItems;
        cartBadge.style.display = totalItems > 0 ? 'inline' : 'none';
      }
    }
    
    function orderProduct(productName, productPrice) {
      addToCart(productName, productPrice);
    }
    
    function proceedToBuy() {
      const cart = getCart();
      
      if (cart.length === 0) {
        alert('Your cart is empty!');
        return;
      }
      
      // Close cart modal immediately
      closeCartModal();
      
      // Build message
      let message = 'I would like to order the following items:\n\n';
      let total = 0;
      
      cart.forEach(item => {
        const price = parseFloat(item.price.replace(/[^0-9.-]+/g, ''));
        message += `â€¢ ${item.name} (${item.price}) x ${item.quantity}\n`;
        total += price * item.quantity;
      });
      
      message += `\nTotal: â‚±${total.toFixed(2)}\n\nPlease confirm availability and delivery.`;
      const encoded = encodeURIComponent(message);

      // First send to WhatsApp
      const whatsappUrl = `https://wa.me/{{ .Site.Params.whatsapp_number }}?text=${encoded}`;
      window.open(whatsappUrl, '_blank');

      // Create and show custom dialog
      const dialog = document.createElement('div');
      dialog.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0,0,0,0.5);
        z-index: 1000;
        text-align: center;
      `;
      
      dialog.innerHTML = `
        <p>Your order has been sent to WhatsApp!</p>
        <p>Click the Messenger button below to also send via Messenger:</p>
        <div style="margin-top: 15px;">
          <a href="#" class="floating-messenger" style="
            display: inline-block;
            padding: 10px 20px;
            background: #0084FF;
            color: white;
            border-radius: 5px;
            text-decoration: none;
            font-weight: bold;
          ">
            <i class="fab fa-facebook-messenger"></i> Send to Messenger
          </a>
        </div>
      `;

      // Create overlay
      const overlay = document.createElement('div');
      overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        z-index: 999;
      `;

      // Add click handler to messenger button in dialog
      dialog.querySelector('.floating-messenger').addEventListener('click', (e) => {
        e.preventDefault();

        // Get the message for messenger
        const messengerId = '61582708015159';
        const m = 'https://m.me/' + messengerId + '?text=' + encoded;
        
        // Open Messenger directly
        window.open(m, '_blank');

        // Remove dialog and overlay after short delay
        setTimeout(() => {
          document.body.removeChild(dialog);
          document.body.removeChild(overlay);
          
          // Clear cart and show confirmation after messenger opens
          localStorage.removeItem(CART_KEY);
          updateCartCount();
          alert('Cart has been cleared!');
        }, 500);
      });

      // Add click handler to overlay for closing
      overlay.addEventListener('click', () => {
        document.body.removeChild(dialog);
        document.body.removeChild(overlay);
        
        // Clear cart when dialog is closed
        localStorage.removeItem(CART_KEY);
        updateCartCount();
        alert('Cart has been cleared!');
      });

      // Add to page
      document.body.appendChild(overlay);
      document.body.appendChild(dialog);
      
      // Auto-clear cart after 10 seconds if user doesn't interact
      setTimeout(() => {
        if (document.body.contains(dialog)) {
          document.body.removeChild(dialog);
          document.body.removeChild(overlay);
          localStorage.removeItem(CART_KEY);
          updateCartCount();
          alert('Cart has been cleared!');
        }
      }, 10000);
    }
    
    function openCartModal() {
      const modal = document.getElementById('cart-modal');
      renderCartItems();
      modal.style.display = 'block';
      document.body.style.overflow = 'hidden'; // Prevent background scrolling
    }
    
    function closeCartModal() {
      const modal = document.getElementById('cart-modal');
      modal.style.display = 'none';
      document.body.style.overflow = 'auto'; // Restore scrolling
    }
    
    function renderCartItems() {
      const cart = getCart();
      const cartItemsContainer = document.getElementById('cart-items');
      const cartEmptyContainer = document.getElementById('cart-empty');
      const cartTotalElement = document.getElementById('cart-total-amount');
      
      if (cart.length === 0) {
        cartItemsContainer.style.display = 'none';
        cartEmptyContainer.style.display = 'block';
        cartTotalElement.textContent = 'Total: â‚±0.00';
        return;
      }
      
      cartItemsContainer.style.display = 'block';
      cartEmptyContainer.style.display = 'none';
      
      let total = 0;
      let cartHTML = '';
      
      cart.forEach((item, index) => {
        const price = parseFloat(item.price.replace(/[^0-9.-]+/g, ''));
        const itemTotal = price * item.quantity;
        total += itemTotal;
        
        cartHTML += `
          <div class="cart-item">
            <div class="cart-item-info">
              <h4>${item.name}</h4>
              <p class="cart-item-price">${item.price} each</p>
            </div>
            <div class="cart-item-controls">
              <div class="cart-quantity-controls">
                <button class="cart-qty-btn" onclick="updateCartQuantity(${index}, ${item.quantity - 1})">-</button>
                <span class="cart-qty-display">${item.quantity}</span>
                <button class="cart-qty-btn" onclick="updateCartQuantity(${index}, ${item.quantity + 1})">+</button>
              </div>
              <div class="cart-item-total">â‚±${itemTotal.toFixed(2)}</div>
              <button class="cart-remove-btn" onclick="removeFromCart(${index})" title="Remove item">
                <i class="fas fa-times"></i>
              </button>
            </div>
          </div>
        `;
      });
      
      cartItemsContainer.innerHTML = cartHTML;
      cartTotalElement.textContent = `Total: â‚±${total.toFixed(2)}`;
    }
    
    function updateCartQuantity(index, newQuantity) {
      const cart = getCart();
      
      if (newQuantity <= 0) {
        cart.splice(index, 1);
      } else if (newQuantity > 9999) {
        cart[index].quantity = 9999;
      } else {
        cart[index].quantity = newQuantity;
      }
      
      saveCart(cart);
      renderCartItems();
    }
    
    function removeFromCart(index) {
      const cart = getCart();
      cart.splice(index, 1);
      saveCart(cart);
      renderCartItems();
    }
    
    function clearCart() {
      if (confirm('Are you sure you want to clear your cart?')) {
        localStorage.removeItem(CART_KEY);
        updateCartCount();
        renderCartItems();
        alert('Cart cleared!');
      }
    }
    
    // Close modal when clicking outside
    window.addEventListener('click', function(event) {
      const modal = document.getElementById('cart-modal');
      if (event.target === modal) {
        closeCartModal();
      }
    });
    
    // Add mobile-friendly event listeners
    function addMobileEventListeners() {
      const cartButton = document.getElementById('cart-button');
      if (cartButton) {
        // Remove any existing onclick
        cartButton.removeAttribute('onclick');
        
        // Add both touch and click events for better mobile compatibility
        cartButton.addEventListener('touchstart', function(e) {
          e.preventDefault();
          openCartModal();
        }, { passive: false });
        
        cartButton.addEventListener('click', function(e) {
          e.preventDefault();
          openCartModal();
        });
      }
    }
    
    // Tab functionality
    document.addEventListener("DOMContentLoaded", function() {
      updateCartCount();
      addMobileEventListeners();
      
      const tabs = document.querySelectorAll(".tab-button");
      const contents = document.querySelectorAll(".tab-content");

      tabs.forEach(tab => {
        tab.addEventListener("click", () => {
          tabs.forEach(t => t.classList.remove("active"));
          contents.forEach(c => c.classList.remove("active"));
          tab.classList.add("active");
          document.getElementById(tab.dataset.tab).classList.add("active");
        });
      });

      // --- contact button behavior: build message from cart or fallback message ---
      function getContactMessage() {
        const cart = getCart();
        if (!cart || cart.length === 0) {
          return 'Hi, I browsed your products and I am interested to purchase. Kindly return my message for more details?';
        }

        let message = 'I would like to order the following items:\n\n';
        let total = 0;
        cart.forEach(item => {
          const price = parseFloat(String(item.price).replace(/[^0-9.-]+/g, '')) || 0;
          message += `â€¢ ${item.name} (${item.price}) x ${item.quantity}\n`;
          total += price * item.quantity;
        });
        message += `\nTotal: â‚±${total.toFixed(2)}\n\nPlease confirm availability and delivery.`;
        return message;
      }

      // Attach click handlers to floating/contact anchors (whatsapp & messenger)
      (function attachFloatingContactHandlers() {
        const whatsappNumber = '{{ .Site.Params.whatsapp_number }}';
        const messengerId = '61582708015159';

        const selectors = [
          'a[href*="wa.me"]',
          'a[href*="api.whatsapp.com"]',
          'a[href*="m.me"]',
          'a[href*="facebook.com/messages"]',
          'a.floating-whatsapp',
          'a.floating-messenger',
          'a.whatsapp',
          'a.messenger'
        ].join(',');

        const anchors = document.querySelectorAll(selectors);
        anchors.forEach(a => {
          a.addEventListener('click', function(e) {
            e.preventDefault();
            
            const cart = getCart();
            const href = (a.getAttribute('href') || '').toLowerCase();
            
            // If cart has items, open cart modal instead of sending message
            if (cart && cart.length > 0) {
              openCartModal();
              return;
            }
            
            // If cart is empty, send the fallback message
            const rawMsg = 'Hi, I browsed your products and I am interested to purchase. Kindly return my message for more details?';
            const encoded = encodeURIComponent(rawMsg);

            if (href.includes('wa.me') || href.includes('api.whatsapp') || a.classList.contains('floating-whatsapp') || a.classList.contains('whatsapp')) {
              const wa = 'https://wa.me/' + whatsappNumber + '?text=' + encoded;
              window.open(wa, '_blank');
              return;
            }

            if (href.includes('m.me') || href.includes('facebook.com/messages') || a.classList.contains('floating-messenger') || a.classList.contains('messenger')) {
              const m = 'https://m.me/' + messengerId + '?text=' + encoded;
              window.open(m, '_blank');
              return;
            }

            // otherwise let the link behave normally
          });
        });
      })();
    });
  </script>
</section>

<!-- ðŸ›’ Cart Modal -->
<div id="cart-modal" class="cart-modal">
  <div class="cart-modal-content">
    <div class="cart-modal-header">
      <h2><i class="fas fa-shopping-cart"></i> Your Cart</h2>
      <button class="cart-modal-close" onclick="closeCartModal()">&times;</button>
    </div>
    <div class="cart-modal-body">
      <div id="cart-items" class="cart-items">
        <!-- Cart items will be populated here -->
      </div>
      <div id="cart-empty" class="cart-empty" style="display: none;">
        <i class="fas fa-shopping-cart"></i>
        <p>Your cart is empty</p>
        <p>Browse our products and add items to your cart</p>
      </div>
    </div>
    <div class="cart-modal-footer">
      <div class="cart-total">
        <h3 id="cart-total-amount">Total: â‚±0.00</h3>
      </div>
      <div class="cart-actions-modal">
        <button class="cart-btn cart-btn-secondary" onclick="clearCart()">
          <i class="fas fa-trash"></i> Clear Cart
        </button>
        <button class="cart-btn cart-btn-primary" onclick="proceedToBuy()">
          <i class="fas fa-credit-card"></i> Proceed to Buy
        </button>
      </div>
    </div>
  </div>
</div>

{{ end }}
